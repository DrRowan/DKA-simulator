<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>DKA-Simulator</title>
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e4/A_drop_of_blood.svg/1024px-A_drop_of_blood.svg.png">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    body { overscroll-behavior-y: none; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
  </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans pb-safe">
  
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const calculateBE = (hco3, ph) => (hco3 - 24.4 + (14.8 * (ph - 7.4))).toFixed(1);

    const Icon = ({ name, size = 24, className = "" }) => {
      const icons = {
        activity: `<path d="M22 12h-4l-3 9L9 3l-3 9H2"/>`,
        droplet: `<path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/>`,
        syringe: `<path d="m18 2 4 4"/><path d="m17 7 3-3"/><path d="M19 9 8.7 19.3c-1 1-2.5 1-3.4 0l-.6-.6c-1-1-1-2.5 0-3.4L15 5"/><path d="m9 11 4 4"/><path d="m5 19-3 3"/><path d="m14 4 6 6"/>`,
        clock: `<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>`,
        check: `<circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/>`,
        heart: `<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>`,
        heartPulse: `<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/><path d="M3.22 12H9.5l.5-1 2 4.5 2-7 1.5 3.5h5.27"/>`,
        beaker: `<path d="M4.5 3h15"/><path d="M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V3"/><path d="M6 14h12"/>`,
        fileText: `<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/>`,
        arrowRight: `<line x1="5" x2="19" y1="12" y2="12"/><polyline points="12 5 19 12 12 19"/>`,
        skull: `<circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/>`,
        fastForward: `<polygon points="13 19 22 12 13 5 13 19"/><polygon points="2 19 11 12 2 5 2 19"/>`,
        alert: `<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/>`,
        clipboard: `<rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/>`,
        star: `<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>`,
        user: `<path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>`,
        wind: `<path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/>`,
        thermometer: `<path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/>`,
        info: `<circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>`,
        plus: `<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>`,
        minus: `<line x1="5" y1="12" x2="19" y2="12"/>`,
        bookOpen: `<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>`,
        x: `<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>`
      };
      
      return (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{ __html: icons[name] }} />
      );
    };

    const generateRandomPatient = () => {
      const typeRand = Math.random();
      const weight = Math.floor(60 + Math.random() * 40);

      let patient = {
        time: 0, totalVolume: 0, totalInsulinGiven: 0, totalPotassiumGiven: 0,
        status: 'active', deathReason: '', events: [], warnings: [],
        weight: weight, dailyBasal: 30, insulinSensitivity: 1.0, lactate: 1.0,
        anamnesis: "", targetDeficit: 0
      };

      const showBasal = Math.random() > 0.5;

      if (typeRand < 0.35) {
        patient.type = 'L√§tt DKA';
        patient.dailyBasal = Math.floor(15 + Math.random() * 30);
        patient.targetDeficit = (weight * 0.05) + Math.random();
        const basalText = showBasal ? ` Tar normalt ${patient.dailyBasal} E basinsulin/dygn.` : ` Uppgift om basinsulin saknas.`;
        patient.hr = 105 + Math.random() * 15;
        patient.bpSys = 110 + Math.random() * 15;
        patient.bpDia = 65 + Math.random() * 10;
        patient.af = 20 + Math.random() * 6;
        patient.temp = 37.5 + Math.random() * 1.2;
        patient.sat = 96 + Math.floor(Math.random() * 4);
        patient.glucose = 18 + Math.random() * 10;
        patient.ketones = 3.5 + Math.random() * 2.5;
        patient.lactate = 1.5 + Math.random() * 1.5;
        patient.k = 4.2 + Math.random() * 1.5;
        patient.na = 132 + Math.random() * 6;
        patient.cl = 98 + Math.random() * 6;
        patient.anamnesis = `22-√•ring med typ 1 diabetes. Vikt: ca ${weight} kg.${basalText} Magsjuka. Sl√∂ men vaken (GCS 15).`;
      } else if (typeRand < 0.75) {
        patient.type = 'Grav DKA';
        patient.dailyBasal = Math.floor(20 + Math.random() * 50);
        patient.targetDeficit = (weight * 0.10) + Math.random();
        const basalText = showBasal ? ` Anh√∂riga uppger basinsulin ${patient.dailyBasal} E/dygn.` : ` Oklar insulindos.`;
        patient.hr = 125 + Math.random() * 20;
        patient.bpSys = 85 + Math.random() * 15;
        patient.bpDia = 50 + Math.random() * 10;
        patient.af = 32 + Math.random() * 8; 
        patient.temp = 36.5 + Math.random() * 1.5; 
        patient.sat = 95 + Math.floor(Math.random() * 5);
        patient.glucose = 30 + Math.random() * 15;
        patient.ketones = 7.5 + Math.random() * 5.0; 
        patient.lactate = 3.0 + Math.random() * 3.0; 
        patient.k = 5.0 + Math.random() * 2.0;
        patient.na = 128 + Math.random() * 7; 
        patient.cl = 94 + Math.random() * 6; 
        patient.anamnesis = `19-√•ring, typ 1 diabetes. Vikt: ${weight} kg. Slutat ta insulin sedan 2 dgr.${basalText} Uttalat dehydrerad, Kussmaulandning. GCS 13.`;
      } else {
        patient.type = 'Oklar Hyperglykemi';
        patient.dailyBasal = Math.floor(20 + Math.random() * 40);
        patient.targetDeficit = (weight * 0.03) + Math.random();
        patient.hr = 85 + Math.random() * 15;
        patient.bpSys = 130 + Math.random() * 20;
        patient.bpDia = 80 + Math.random() * 10;
        patient.af = 14 + Math.random() * 6;
        patient.temp = 37.0 + Math.random() * 0.8;
        patient.sat = 97 + Math.floor(Math.random() * 4);
        patient.glucose = 22 + Math.random() * 8;
        patient.ketones = 0.2 + Math.random() * 0.4;
        patient.lactate = 1.0 + Math.random() * 0.8;
        patient.k = 4.0 + Math.random() * 0.8;
        patient.na = 134 + Math.random() * 6;
        patient.cl = 100 + Math.random() * 4;
        patient.anamnesis = `55-√•ring, nyuppt√§ckt diabetes. Vikt: ${weight} kg. S√∂ker pga tr√∂tthet/polyuri. M√•r relativt bra. Uppgift om insulinresistens saknas. GCS 15.`;
      }

      patient.insulinSensitivity = 30 / patient.dailyBasal;
      patient.be = (patient.na - patient.cl - 38) - patient.ketones - patient.lactate;
      let eff_hco3 = Math.max(2.0, 24.4 + patient.be);
      let pco2_mmHg = Math.max(10, 1.5 * eff_hco3 + 8);
      patient.pco2 = pco2_mmHg / 7.5; 
      patient.ph = 6.1 + Math.log10(eff_hco3 / (0.03 * pco2_mmHg));
      patient.osmolarity = 2 * patient.na + patient.glucose;

      return patient;
    };const LogicModal = ({ isOpen, onClose }) => {
      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
          <div className="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden animate-in fade-in zoom-in duration-200">
            <div className="p-4 border-b border-gray-200 flex justify-between items-center bg-slate-50">
              <h2 className="text-lg md:text-xl font-bold text-slate-800 flex items-center gap-2">
                <Icon name="bookOpen" className="text-indigo-500" /> Fysiologisk Motor
              </h2>
              <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full transition-colors">
                <Icon name="x" size={20} className="text-slate-500" />
              </button>
            </div>
            <div className="p-4 md:p-6 overflow-y-auto space-y-6 text-sm md:text-base text-slate-700">
              <section>
                <h3 className="font-bold text-indigo-700 text-lg mb-2">1. Syra-Bas & Stewart-Modellen</h3>
                <p className="mb-2">Applikationen anv√§nder Fencl-Stewart-metoden (Standard Base Excess och Strong Ion Difference) f√∂r att ber√§kna syra-bas-balansen.</p>
                <ul className="list-disc pl-5 space-y-1 bg-indigo-50/50 p-3 rounded-lg border border-indigo-100">
                  <li><strong>Formel:</strong> <code className="bg-white px-1 py-0.5 rounded text-indigo-600">SBE = (Na - Cl - 38) - Ketoner - Laktat</code></li>
                  <li>SBE blir negativt (acidos) om Ketoner/Laktat √§r h√∂ga, <em>eller</em> om differensen mellan Na och Cl √§r f√∂r liten (&lt; 38).</li>
                  <li><strong>pCO2 (Kompensation):</strong> Drivs av SBE. <code className="bg-white px-1 py-0.5 rounded text-indigo-600">pCO2 (kPa) = 5.3 + (SBE * 0.15)</code></li>
                  <li><strong>pH:</strong> Ber√§knas via Henderson-Hasselbalch fr√•n det kompensatoriska pCO2-v√§rdet.</li>
                </ul>
              </section>
              <section>
                <h3 className="font-bold text-indigo-700 text-lg mb-2">2. Ketoner & Insulinresistens</h3>
                <p className="mb-2">Insulin har tv√• separata fysiologiska effekter i modellen:</p>
                <ul className="list-disc pl-5 space-y-1">
                  <li><strong>Nyproduktion:</strong> Avstannar n√§stan helt vid l√•ga insulindoser (&gt;1 E/h).</li>
                  <li><strong>Clearance (Rensning):</strong> F√∂r att rensa bort <em>befintliga</em> ketoner kr√§vs att man √∂vervinner patientens insulinresistens. En √∂verviktig patient med h√∂gt basinsulinbehov kr√§ver ett snabbare insulindropp f√∂r samma ketons√§nkning.</li>
                </ul>
              </section>
              <section>
                <h3 className="font-bold text-indigo-700 text-lg mb-2">3. Hypovolemi & V√§tskedeficit</h3>
                <p className="mb-2">Varje patient genereras med ett dolt v√§tskedeficit (ofta runt 7-10% av kroppsvikten vid grav DKA). Om man underbehandlar detta deficit aktiveras "den onda spiralen":</p>
                 <ul className="list-disc pl-5 space-y-1">
                  <li><strong>Minskad Perfusion:</strong> L√•g blodvolym s√§nker njur- och v√§vnadsperfusionen drastiskt.</li>
                  <li><strong>Insulinresistens √∂kar:</strong> Utan perfusion n√•r insulinet inte fram till v√§vnaderna och ketonerna slutar sjunka.</li>
                  <li><strong>Laktatstegring:</strong> Ischemin leder till att laktat stiger och SBE f√∂rblir l√•gt.</li>
                  <li><strong>Risk f√∂r kollaps:</strong> Att ge insulin innan man korrigerat den initiala chocken med v√§tska kan leda till letal kardiovaskul√§r kollaps.</li>
                </ul>
              </section>
              <section>
                <h3 className="font-bold text-indigo-700 text-lg mb-2">4. Val av v√§tskor & Hyperkloremisk Acidos</h3>
                <p className="mb-2">Valet av infusionsv√§tska p√•verkar direkt patientens anjongap (SID).</p>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
                  <div className="bg-slate-50 p-3 rounded border border-slate-200">
                    <strong className="text-slate-800 block mb-1">NaCl 0.9%</strong>
                    Inneh√•ller Na 154 och Cl 154. Att ge mycket NaCl s√§nker patientens (Na - Cl) differens och skapar oundvikligen en iatrogen hyperkloremisk acidos.
                  </div>
                  <div className="bg-slate-50 p-3 rounded border border-slate-200">
                    <strong className="text-slate-800 block mb-1">Ringer-Acetat</strong>
                    Inneh√•ller Na 130 och Cl 112. Acetatet fungerar som en buffert, vilket matematiskt i modellen bevarar patientens anjongap och hj√§lper till att h√§va acidosen.
                  </div>
                </div>
              </section>
            </div>
            <div className="p-4 border-t border-gray-200 bg-slate-50 flex justify-end">
              <button onClick={onClose} className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-bold transition-colors">
                F√∂rst√•tt
              </button>
            </div>
          </div>
        </div>
      );
    };

    function App() {
      const [patient, setPatient] = useState(() => generateRandomPatient());
      const [history, setHistory] = useState([]);
      const logsEndRef = useRef(null);
      const evalRef = useRef(null); 
      const [isModalOpen, setIsModalOpen] = useState(false);

      const [fluidType, setFluidType] = useState('Ringer-Acetat');
      const [fluidRate, setFluidRate] = useState(1000);
      const [insulinRate, setInsulinRate] = useState(0);
      const [potassiumRate, setPotassiumRate] = useState(0);

      useEffect(() => {
        if (history.length === 0) setHistory([patient]);
      }, [patient, history]);

      useEffect(() => {
        if (patient.events.length > 0 && patient.status === 'active') {
          logsEndRef.current?.scrollIntoView({ behavior: "smooth" });
        }
      }, [patient.events, patient.status]);

      useEffect(() => {
        if (patient.status !== 'active') {
          setTimeout(() => {
            evalRef.current?.scrollIntoView({ behavior: "smooth", block: "start" });
          }, 100);
        }
      }, [patient.status]);

      const advanceTime = (hours) => {
        if (patient.status !== 'active') return;

        let p = { ...patient };
        let newEvents = [...p.events];
        let timeStr = `[+${hours === 0.5 ? '30m' : '1h'} / Tot ${p.time + hours}h]`;
        let currentTime = p.time + hours;

        let volumeAdded_L = (fluidRate * hours) / 1000;
        p.totalVolume += volumeAdded_L;
        p.totalInsulinGiven += (insulinRate * hours);
        p.totalPotassiumGiven += (potassiumRate * hours);

        let currentDeficit = Math.max(0, p.targetDeficit - p.totalVolume);
        let deficitPercent = currentDeficit / p.weight;
        
        let perfusionFactor = 1.0;
        if (deficitPercent > 0.10) perfusionFactor = 0.2; 
        else if (deficitPercent > 0.05) perfusionFactor = 0.5; 
        else if (deficitPercent > 0.02) perfusionFactor = 0.8; 
        
        if (p.totalVolume > 2.5 && perfusionFactor < 0.6) perfusionFactor = 0.6; 

        let glucDropInsulin = insulinRate * 0.4 * hours * perfusionFactor * p.insulinSensitivity; 
        let fluidDropFactor = p.glucose > 30 ? 2.5 : (p.glucose > 15 ? 1.0 : 0.2);
        let glucDropFluid = volumeAdded_L * fluidDropFactor * perfusionFactor;
        
        let glucAdded = 0;
        if (fluidType === 'Glukos 5%') glucAdded = (volumeAdded_L * 278) / (40 + volumeAdded_L);
        else if (fluidType === 'Glukos 10%') glucAdded = (volumeAdded_L * 555) / (40 + volumeAdded_L);

        let endogenousGlucoseProduction = 0;
        if (insulinRate < 1.0) {
           endogenousGlucoseProduction = p.type.includes('DKA') ? 2.0 * hours : 0.5 * hours;
        }

        let prevGluc = p.glucose;
        p.glucose = p.glucose - glucDropInsulin - glucDropFluid + glucAdded + endogenousGlucoseProduction;

        if (insulinRate === 0 && p.glucose < 12) {
             p.glucose = Math.max(10, p.glucose + 1.0); 
        }
        
        if (p.glucose < 0.1) p.glucose = 0.1;

        let prevKetones = p.ketones;
        let ketoneProduction = p.type.includes('DKA') ? Math.max(0, 0.5 - (insulinRate * 0.5)) : Math.max(0, 0.1 - (insulinRate * 0.2));
        let ketoneSensitivity = p.type.includes('DKA') ? 0.15 : 0.3;
        
        let ketoneClearance = (insulinRate * ketoneSensitivity * perfusionFactor * p.insulinSensitivity);

        p.ketones = p.ketones + (ketoneProduction * hours) - (ketoneClearance * hours);
        if (p.ketones < 0.1) p.ketones = 0.1;

        let laktatEffekt = 0;
        if (perfusionFactor < 0.4) {
            laktatEffekt = (0.5 - perfusionFactor) * hours; 
        } else {
            laktatEffekt = -((volumeAdded_L * 0.4) + (0.2 * hours * perfusionFactor)); 
        }
        p.lactate = Math.max(0.8, p.lactate + laktatEffekt);

        let prevPh = p.ph;
        let prevOsm = p.osmolarity;

        let renalCorrection = 0.20 * hours * perfusionFactor; 
        
        let distributionVol = fluidType.includes('Glukos') ? 40 : 15;
        let naAdded = fluidType === 'NaCl 0.9%' ? 154 * volumeAdded_L : (fluidType === 'Ringer-Acetat' ? 130 * volumeAdded_L : 0);
        let clAdded = fluidType === 'NaCl 0.9%' ? 154 * volumeAdded_L : (fluidType === 'Ringer-Acetat' ? 112 * volumeAdded_L : 0);

        p.na = ((p.na * distributionVol) + naAdded) / (distributionVol + volumeAdded_L);
        p.cl = ((p.cl * distributionVol) + clAdded) / (distributionVol + volumeAdded_L);

        p.na = p.na + (140 - p.na) * renalCorrection;
        p.cl = p.cl + (102 - p.cl) * renalCorrection;

        let kDropInsulin = (insulinRate * 0.08) * hours * p.insulinSensitivity;
        
        p.be = (p.na - p.cl - 38) - p.ketones - p.lactate;
        let eff_hco3 = Math.max(2.0, 24.4 + p.be);
        let targetPco2_mmHg = Math.max(10, 1.5 * eff_hco3 + 8);
        let targetPco2_kPa = targetPco2_mmHg / 7.5;
        
        p.pco2 = p.pco2 + (targetPco2_kPa - p.pco2) * 0.8 * hours;

        let currentPco2_mmHg = p.pco2 * 7.5;
        p.ph = 6.1 + Math.log10(eff_hco3 / (0.03 * currentPco2_mmHg));

        let kDropPh = (p.ph - prevPh) > 0 ? ((p.ph - prevPh) / 0.1) * 0.4 : 0;
        let kAdded = (potassiumRate * hours) / 15; 
        p.k = p.k - kDropInsulin - kDropPh + kAdded - (0.1 * hours);

        p.osmolarity = 2 * p.na + p.glucose;
        let osmDropRate = (prevOsm - p.osmolarity) / hours;

        if (deficitPercent > 0.08) {
            p.bpSys = Math.max(60, p.bpSys - (5 * hours)); 
            p.hr = Math.min(150, p.hr + (5 * hours));
        } else {
            p.hr = Math.max(65, p.hr - (volumeAdded_L * 15));
            p.bpSys = Math.min(130, p.bpSys + (volumeAdded_L * 20));
        }
        p.bpDia = Math.min(80, p.bpDia + (volumeAdded_L * 10));

        let targetAf = Math.max(14, 14 + (40 - currentPco2_mmHg) * 0.8);
        p.af = p.af + (targetAf - p.af) * 0.5 * hours;

        p.temp = p.temp + (37.0 - p.temp) * 0.2 * hours;
        p.sat = Math.min(100, Math.max(92, p.sat + (Math.random() * 2 - 1)));

        let isDead = false;
        let causeOfDeath = '';

        if (p.glucose <= 2.0) { isDead = true; causeOfDeath = 'Grav hypoglykemi -> Krampanfall/hj√§rnskada.'; }
        else if (p.k <= 2.2) { isDead = true; causeOfDeath = 'Grav hypokalemi -> Ventrikelflimmer.'; }
        else if (p.k >= 8.5) { isDead = true; causeOfDeath = 'Grav hyperkalemi -> Asystoli.'; }
        else if (p.ph <= 6.75) { isDead = true; causeOfDeath = 'Grav acidos -> Cirkulatorisk kollaps.'; }
        else if (p.ketones >= 16) { isDead = true; causeOfDeath = 'Obehandlad extrem ketoacidos.'; }
        else if (p.osmolarity > 350) { isDead = true; causeOfDeath = 'Hyperosmol√§rt koma.'; }
        else if (p.bpSys < 65) { isDead = true; causeOfDeath = 'Grav hypovolemi -> Kardiovaskul√§r kollaps. (Underbehandlat v√§tskedeficit)'; }
        else if (insulinRate > 0 && p.totalVolume < 0.5 && p.type.includes('DKA') && p.bpSys < 100) {
             isDead = true; causeOfDeath = 'Kardiovaskul√§r kollaps pga osmotiskt shift. Du gav insulin innan adekvat rehydrering.';
        }

        if (isDead) {
          newEvents.push(`${timeStr} üíÄ PATIENTEN AVLIDER: ${causeOfDeath}`);
          p.status = 'dead';
          p.deathReason = causeOfDeath;
        } else {
          // Vinstvillkoret har √•terst√§llts till endast kliniska m√•l (pH och ketoner)
          if (p.type.includes('DKA')) {
              if (p.ph >= 7.30 && p.ketones <= 0.6) {
                newEvents.push(`${timeStr} ‚úÖ SUCCESS: Ketoacidosen √§r h√§vd!`);
                p.status = 'success';
              }
          } else { 
              if (p.glucose < 10) {
                  newEvents.push(`${timeStr} ‚úÖ SUCCESS: Hyperglykemin √§r behandlad.`);
                  p.status = 'success';
              }
          }
        }

        const addWarning = (icon, msg) => {
          const recentlyLogged = p.warnings.some(w => w.msg === msg && (currentTime - w.time) <= 1.5);
          if (!recentlyLogged) {
            p.warnings.push({ time: currentTime, icon, msg });
          }
        };

        if (p.type.includes('DKA') && insulinRate > 0 && p.totalVolume < 0.5) {
            addWarning('üíß', `Insulin startades innan rehydrering p√•b√∂rjats. Stor risk f√∂r cirkulatorisk kollaps.`);
        }
        if (p.type.includes('DKA') && currentTime >= 3.0 && deficitPercent > 0.06) {
            addWarning('üê™', `Patienten √§r fortfarande gravt hypovolem (Estimerat kvarvarande deficit > 5-6% av kroppsvikt). V√§vnaderna √§r hypoperfunderade vilket ger laktatstegring och kraftig insulinresistens.`);
        }
        if (osmDropRate > 4.0) addWarning('üß†', `Osmolariteten sj√∂nk f√∂r snabbt (${osmDropRate.toFixed(1)} mOsm/h). Risk f√∂r hj√§rn√∂dem.`);
        if (p.k < 3.3) addWarning('‚ö°', `Kritisk hypokalemi (K: ${p.k.toFixed(1)}). Insulinet borde ha pausats.`);
        if (p.glucose < 14 && fluidType.indexOf('Glukos') === -1 && prevGluc >= 14 && p.type.includes('DKA')) addWarning('üç¨', `Blodsocker < 14 utan glukosdropp. Risk f√∂r hypoglykemi.`);
        if (insulinRate > 0 && p.ketones < 0.6 && !p.type.includes('DKA') && prevGluc > 15) addWarning('üíâ', `Insulin gavs trots avsaknad av ketoner. V√§tska r√§cker ofta.`);
        if (insulinRate === 0 && p.ketones > 1 && p.time > 0 && p.type.includes('DKA')) addWarning('‚ö†Ô∏è', `Inget insulin gavs. Ketonproduktionen skenade.`);
        
        let ketoneDropRate = (prevKetones - p.ketones) / hours;
        if (p.type.includes('DKA') && insulinRate > 0 && ketoneDropRate < 0.3 && p.ketones > 1.5) {
            if (perfusionFactor < 0.6) {
                addWarning('üìâ', `Otillr√§cklig ketonclearance. Insulinet n√•r inte ut pga hypovolemi/d√•lig perfusion. √ñka takten p√• Ringer-droppet.`);
            } else {
                addWarning('üìâ', `Otillr√§cklig ketonclearance (${ketoneDropRate.toFixed(2)} mmol/h). Kr√§ver h√∂gre insulindos.`);
            }
        }
        
        let sid = p.na - p.cl;
        if (sid < 30 && p.ketones < 1.5 && fluidType === 'NaCl 0.9%') {
          addWarning('üßÇ', `Iatrogen hyperkloremisk acidos (SID: ${sid.toFixed(0)}, Cl: ${p.cl.toFixed(0)}). Beror p√• √∂veranv√§ndning av NaCl 0.9%.`);
        }

        if (newEvents.length === p.events.length) {
          newEvents.push(`${timeStr} Behandling forts√§tter. V: ${fluidRate}ml/h, I: ${insulinRate}E/h, K: ${potassiumRate}mmol/h`);
        }

        p.time += hours;
        p.events = newEvents;

        setPatient(p);
        setHistory([...history, p]);
      };

      const getFace = () => {
        if (patient.status === 'dead') return "üíÄ";
        if (patient.status === 'success') return "ü•≥";
        if (patient.ph < 7.10) return "üò´";
        if (patient.ph < 7.25) return "ü§í";
        if (patient.glucose < 4.0) return "ü•∂";
        return "üòê";
      };

      const resetGame = () => {
        const newPatient = generateRandomPatient();
        setPatient(newPatient);
        setHistory([newPatient]);
        setFluidType('Ringer-Acetat');
        setFluidRate(1000); 
        setInsulinRate(0);
        setPotassiumRate(0);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };

      const valColor = (val, min, max, critMin, critMax) => {
        if (val <= critMin || val >= critMax) return "text-red-600 font-bold";
        if (val < min || val > max) return "text-orange-500 font-semibold";
        return "text-green-600 font-medium";
      };

      const TimeActions = ({ isMobile }) => (
        <div className={`grid grid-cols-2 gap-3 ${isMobile ? 'max-w-md mx-auto' : 'mt-6'}`}>
          <button onClick={() => advanceTime(0.5)} disabled={patient.status !== 'active'} className="py-3 md:py-4 rounded-xl font-bold text-white bg-slate-700 hover:bg-slate-600 disabled:bg-slate-300 disabled:cursor-not-allowed flex items-center justify-center gap-2 active:scale-95 text-sm md:text-base">
            <Icon name="fastForward" size={18} /> + 30 min
          </button>
          <button onClick={() => advanceTime(1.0)} disabled={patient.status !== 'active'} className="py-3 md:py-4 rounded-xl font-bold text-white bg-slate-900 hover:bg-slate-800 disabled:bg-slate-300 disabled:cursor-not-allowed flex items-center justify-center gap-2 active:scale-95 shadow-md text-sm md:text-base">
            <Icon name="arrowRight" size={18} /> + 1 timme
          </button>
        </div>
      );

      const ControlButtons = ({ value, setValue, step, min, max, unit }) => (
        <div className="flex items-center justify-between bg-white border border-slate-200 rounded-lg p-1">
          <button onClick={() => setValue(Math.max(min, value - step))} disabled={patient.status !== 'active' || value <= min} className="w-10 h-10 md:w-12 md:h-12 flex items-center justify-center bg-slate-100 hover:bg-slate-200 rounded-md text-slate-700 disabled:opacity-50">
            <Icon name="minus" size={20} />
          </button>
          <div className="flex flex-col items-center justify-center px-2 min-w-[4rem]">
            <span className="font-black text-xl md:text-2xl text-slate-800 leading-none">{value}</span>
            <span className="text-[10px] md:text-xs text-slate-500 font-medium">{unit}</span>
          </div>
          <button onClick={() => setValue(Math.min(max, value + step))} disabled={patient.status !== 'active' || value >= max} className="w-10 h-10 md:w-12 md:h-12 flex items-center justify-center bg-slate-100 hover:bg-slate-200 rounded-md text-slate-700 disabled:opacity-50">
            <Icon name="plus" size={20} />
          </button>
        </div>
      );

      const ControlsMenu = () => (
        <div className="bg-white p-4 md:p-6 rounded-2xl shadow-lg border border-slate-200 lg:sticky lg:top-24">
          <h2 className="text-lg md:text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">Ordinationer</h2>
          <div className="mb-4 p-3 md:p-4 rounded-xl bg-blue-50 border border-blue-100">
            <label className="text-xs md:text-sm font-bold text-blue-900 mb-2 flex items-center gap-2">
              <Icon name="droplet" size={16} className="text-blue-500"/> Intraven√∂s V√§tska
            </label>
            <select className="w-full p-2 border border-blue-200 rounded-lg bg-white mb-3 text-sm font-semibold focus:outline-none" value={fluidType} onChange={e => setFluidType(e.target.value)} disabled={patient.status !== 'active'}>
              <option value="Ringer-Acetat">Ringer-Acetat</option>
              <option value="NaCl 0.9%">NaCl 0.9%</option>
              <option value="Glukos 5%">Gl